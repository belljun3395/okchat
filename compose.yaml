services:
    # =============================================================================
    #  Search Services
    # =============================================================================
    okchat-opensearch:
        image: 'opensearchproject/opensearch:2.18.0'
        container_name: okchat-opensearch
        environment:
            - discovery.type=single-node
            - DISABLE_SECURITY_PLUGIN=true # Disable security for local development
            - OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g
            - cluster.routing.allocation.disk.threshold_enabled=false
            - action.auto_create_index=true  # Allow automatic index creation
        volumes:
            - './opensearch-data:/usr/share/opensearch/data'
        ports:
            - '9200:9200'  # REST API
            - '9600:9600'  # Performance Analyzer
        networks:
            - okchat-network
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:9200/_cluster/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 60s
    
    okchat-opensearch-dashboards:
        image: 'opensearchproject/opensearch-dashboards:2.18.0'
        container_name: okchat-opensearch-dashboards
        environment:
            - OPENSEARCH_HOSTS=http://okchat-opensearch:9200
            - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true  # Disable security for local development
        ports:
            - '5601:5601'
        networks:
            - okchat-network
        depends_on:
            okchat-opensearch:
                condition: service_healthy
    # =============================================================================
    # Database Services
    # =============================================================================
    okchat-mysql:
        container_name: okchat-mysql8
        image: mysql/mysql-server:8.0.27
        networks:
            - okchat-network
        environment:
            - MYSQL_ROOT_PASSWORD=root
            - MYSQL_ROOT_HOST=%
            - TZ=Asia/Seoul
        command: [
            "--character-set-server=utf8mb4",
            "--collation-server=utf8mb4_unicode_ci",
            "--lower_case_table_names=1",
            "--max_connections=2048",
            "--wait_timeout=3600"
        ]
        ports:
            - "13306:3306"  # MySQL Database
        volumes:
            - ./resources/mysql-init.d:/docker-entrypoint-initdb.d
        healthcheck:
            test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 30s
        restart: unless-stopped

    okchat-adminer:
        container_name: okchat-adminer
        image: adminer:4
        networks:
            - okchat-network
        ports:
            - "18080:8080"  # MySQL Web Admin
        environment:
            - ADMINER_DEFAULT_SERVER=okchat-mysql8
            - ADMINER_DESIGN=nette
            - ADMINER_PLUGINS=tables-filter tinymce

    # =============================================================================
    # Cache Services
    # =============================================================================
    okchat-redis:
        image: redis:latest
        container_name: okchat-redis
        ports:
            - "16379:6379"

    okchat-redis-insight:
        image: redislabs/redisinsight:latest
        container_name: okchat-redis-insight
        ports:
            - "18081:5540"
    # =============================================================================
    # Monitoring Services
    # =============================================================================
    okchat-prometheus:
        image: prom/prometheus:latest
        container_name: okchat-prometheus
        volumes:
            - ./prometheus.yml:/etc/prometheus/prometheus.yml
        ports:
            - "9090:9090"
        networks:
            - okchat-network
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'

    okchat-tempo:
        image: grafana/tempo:latest
        container_name: okchat-tempo
        command: [ "-config.file=/etc/tempo.yaml" ]
        volumes:
            - ./grafana/tempo-config.yaml:/etc/tempo.yaml
        ports:
            - "3200:3200"   # Jaeger compact
            - "4317:4317"   # OTLP gRPC
            - "4318:4318"   # OTLP HTTP
        networks:
            - okchat-network

    okchat-grafana:
        image: grafana/grafana:latest
        container_name: okchat-grafana
        ports:
            - "3000:3000"
        networks:
            - okchat-network
        volumes:
            - ./grafana/provisioning:/etc/grafana/provisioning
            - ./grafana/dashboards:/var/lib/grafana/dashboards
        environment:
            - GF_SECURITY_ADMIN_PASSWORD=admin
        depends_on:
            - okchat-prometheus
            - okchat-tempo

networks:
    okchat-network:
        driver: bridge
