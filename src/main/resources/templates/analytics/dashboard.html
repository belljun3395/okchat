<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - OKChat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-sidebar-header">
                <a href="/admin/permissions" class="nav-brand">
                    OKChat Admin
                </a>
            </div>
            <nav class="admin-sidebar-nav">
                <a href="/admin/permissions" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                    Dashboard
                </a>
                <a href="/admin/permissions/users" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                    Users
                </a>
                <a href="/admin/permissions/paths" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                    </svg>
                    Paths
                </a>
                <a href="/admin/permissions/manage" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                    </svg>
                    Permissions
                </a>
                <a href="/admin/chat/analytics" class="nav-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" />
                    </svg>
                    Analytics
                </a>
                <a href="/admin/email/review" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                    </svg>
                    Email Review
                </a>
            </nav>
            <div class="admin-sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="user-info">
                        <div class="user-name">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Page Header -->
            <div class="mb-8">
                <h1 class="mb-2">Chat Analytics</h1>
                <p class="text-secondary">Analyze the performance of your chatbot interactions with detailed metrics.</p>
            </div>

            <!-- Filters -->
            <div class="flex justify-between items-center mb-6">
                <div class="input-group mb-0">
                    <input type="text" class="form-control" placeholder="Search interactions..." style="width: 300px; padding-left: 36px; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGZpbGw9Im5vbmUiIHZpZXdCb3g9IjAgMCAyNCAyNCIgc3Ryb2tlLXdpZHRoPSIxLjUiIHN0cm9rZT0iIzlDQTNBRiIgY2xhc3M9Inc2IGg2Ij4KICA8cGF0aCBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiIGQ9Ik0yMSAyMWwtNS4xOTctNS4xOTdtMCAwQTE3LjUgNy41IDAgMSAwIDUuMTk2IDUuMTk2YTcuNSA3LjUgMCAwIDAgMTAuNjA3IDEwLjYwN1oiIC8+Cjwvc3ZnPgo='); background-repeat: no-repeat; background-position: 10px center; background-size: 16px;">
                </div>
                <div class="flex gap-sm">
                    <select class="form-control" style="width: auto;">
                        <option>Last 7 Days</option>
                        <option>Last 30 Days</option>
                        <option>This Month</option>
                    </select>
                    <select class="form-control" style="width: auto;">
                        <option>All Statuses</option>
                        <option>Active</option>
                        <option>Resolved</option>
                    </select>
                    <button class="btn btn-secondary" onclick="loadAnalytics()">Refresh</button>
                </div>
            </div>

            <h3 class="mb-4">Overall Performance</h3>

            <!-- KPI Cards -->
            <div class="grid grid-cols-3 gap-lg mb-8">
                <div class="card">
                    <div class="text-sm text-secondary font-medium mb-2">Total Interactions</div>
                    <div class="text-4xl font-bold text-main mb-2" id="totalInteractions">-</div>
                    <div class="flex items-center text-sm font-medium text-secondary" id="interactionsTrend">
                        <span>-</span>
                    </div>
                </div>
                <div class="card">
                    <div class="text-sm text-secondary font-medium mb-2">Avg Response Time</div>
                    <div class="text-4xl font-bold text-main mb-2"><span id="avgResponseTime">-</span><span class="text-xl text-secondary font-normal ml-1">ms</span></div>
                    <div class="flex items-center text-sm font-medium text-secondary" id="responseTimeTrend">
                        <span>-</span>
                    </div>
                </div>
                <div class="card">
                    <div class="text-sm text-secondary font-medium mb-2">User Satisfaction</div>
                    <div class="text-4xl font-bold text-main mb-2" id="avgRating">-</div>
                    <div class="flex items-center text-sm font-medium text-secondary">
                        <span id="helpfulPercent">-</span>
                        <span class="ml-1 text-secondary font-normal">helpful</span>
                    </div>
                </div>
            </div>

            <h3 class="mb-4">Interaction Volume Over Time</h3>

            <!-- Chart Section -->
            <div class="card mb-8 p-6">
                <div style="height: 300px; width: 100%;">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <h3 class="mb-4">Query Type Details</h3>

            <!-- Table Section -->
            <div class="card p-0 overflow-hidden">
                <div class="table-container border-0 rounded-none">
                    <div id="queryTypeStats">
                        <div class="p-8 text-center text-muted">Loading data...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden inputs for JS logic -->
    <input type="hidden" id="startDate">
    <input type="hidden" id="endDate">

    <script>
        // Initialize dates
        const now = new Date();
        const yesterday = new Date(now - 7 * 24 * 60 * 60 * 1000); // Last 7 days default
        
        function formatDateTimeLocal(date) {
            return date.toISOString().slice(0, 16);
        }

        document.getElementById('startDate').value = formatDateTimeLocal(yesterday);
        document.getElementById('endDate').value = formatDateTimeLocal(now);

        // Chart.js Setup
        let mainChart = null;

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            // Gradient for the chart
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(37, 99, 235, 0.1)'); // Blue with opacity
            gradient.addColorStop(1, 'rgba(37, 99, 235, 0)');

            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Interactions',
                        data: [], // Data will be loaded via API
                        borderColor: '#2563EB',
                        backgroundColor: gradient,
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            backgroundColor: '#1F2937',
                            titleColor: '#F9FAFB',
                            bodyColor: '#F9FAFB',
                            padding: 10,
                            cornerRadius: 4,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                borderDash: [4, 4],
                                color: '#E5E7EB',
                                drawBorder: false
                            },
                            ticks: { color: '#9CA3AF', font: { size: 11 } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: '#9CA3AF', font: { size: 11 } }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    }
                }
            });
        }

        async function loadAnalytics() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            try {
                await Promise.all([
                    loadUsageStats(startDate, endDate),
                    loadQualityStats(startDate, endDate),
                    loadQueryTypeStats(startDate, endDate)
                ]);
            } catch (error) {
                console.error("Error loading analytics", error);
            }
        }

        async function loadUsageStats(startDate, endDate) {
            const response = await fetch(`/api/admin/chat/analytics/usage/daily?startDate=${startDate}&endDate=${endDate}`);
            const data = await response.json();
            
            document.getElementById('totalInteractions').textContent = data.totalInteractions.toLocaleString();
            document.getElementById('avgResponseTime').textContent = Math.round(data.averageResponseTime);
        }

        async function loadQualityStats(startDate, endDate) {
            const response = await fetch(`/api/admin/chat/analytics/quality/trend?startDate=${startDate}&endDate=${endDate}`);
            const data = await response.json();
            
            document.getElementById('avgRating').textContent = data.averageRating.toFixed(2);
            document.getElementById('helpfulPercent').textContent = `${data.helpfulPercentage.toFixed(1)}%`;
        }

        async function loadQueryTypeStats(startDate, endDate) {
            const response = await fetch(`/api/admin/chat/analytics/query-types?startDate=${startDate}&endDate=${endDate}`);
            const data = await response.json();
            
            let html = '<table class="table"><thead><tr><th>QUERY TYPE</th><th>COUNT</th><th>AVG TIME</th><th>SATISFACTION</th></tr></thead><tbody>';
            
            if (!data || data.length === 0) {
                html += '<tr><td colspan="4" class="text-center p-4 text-muted">No data available</td></tr>';
            } else {
                data.forEach((item) => {
                    html += `<tr>
                        <td class="font-medium text-main">${item.queryType}</td>
                        <td>${item.count.toLocaleString()}</td>
                        <td>${Math.round(item.averageResponseTime)}ms</td>
                        <td>
                            <div class="flex items-center gap-sm">
                                <div style="width: 60px; height: 6px; background: #E5E7EB; border-radius: 3px; overflow: hidden;">
                                    <div style="width: ${item.averageRating * 20}%; height: 100%; background: var(--primary);"></div>
                                </div>
                                <span class="text-xs text-secondary">${item.averageRating.toFixed(1)}</span>
                            </div>
                        </td>
                    </tr>`;
                });
            }
            html += '</tbody></table>';
            document.getElementById('queryTypeStats').innerHTML = html;
        }

        // Initialize
        initChart();
        loadAnalytics();
    </script>
</body>
</html>
