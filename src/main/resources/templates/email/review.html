<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Review - OKChat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .email-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        
        .email-item {
            padding: var(--space-lg);
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        
        .email-item:hover {
            background-color: #F9FAFB;
        }
        
        .email-preview {
            background: #F3F4F6;
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            margin: var(--space-md) 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
            max-height: 80px;
            overflow: hidden;
            position: relative;
            border: 1px solid var(--border-color);
        }
        
        .email-preview.expanded {
            max-height: none;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-sidebar-header">
                <a href="/admin/permissions" class="nav-brand">
                    OKChat Admin
                </a>
            </div>
            <nav class="admin-sidebar-nav">
                <a href="/admin/permissions" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
                    </svg>
                    Dashboard
                </a>
                <a href="/admin/permissions/users" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                    </svg>
                    Users
                </a>
                <a href="/admin/permissions/paths" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" />
                    </svg>
                    Paths
                </a>
                <a href="/admin/permissions/manage" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                    </svg>
                    Permissions
                </a>
                <a href="/admin/chat/analytics" class="nav-item">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5M9 11.25v1.5M12 9v3.75m3-6v6" />
                    </svg>
                    Analytics
                </a>
                <a href="/admin/email/review" class="nav-item active">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                    </svg>
                    Email Review
                </a>
            </nav>
            <div class="admin-sidebar-footer">
                <div class="user-profile">
                    <div class="user-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                          <path fill-rule="evenodd" d="M7.5 6a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM3.751 20.105a8.25 8.25 0 0116.498 0 .75.75 0 01-.437.695A18.683 18.683 0 0112 22.5c-2.786 0-5.433-.608-7.812-1.7a.75.75 0 01-.437-.695z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="user-info">
                        <div class="user-name">Admin</div>
                        <div class="user-role">Administrator</div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
        <div class="flex justify-between items-center mb-8 animate-fade-in">
            <div>
                <h1 class="mb-2">Email Review</h1>
                <p class="text-secondary">Review, approve, or reject pending email responses</p>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-4 gap-md mb-8 animate-fade-in delay-100">
            <div class="card text-center p-4">
                <div class="text-3xl font-bold text-warning mb-1" id="pendingCount">0</div>
                <div class="text-xs font-medium text-secondary uppercase tracking-wide">Pending</div>
            </div>
            <div class="card text-center p-4">
                <div class="text-3xl font-bold text-success mb-1" id="approvedCount">0</div>
                <div class="text-xs font-medium text-secondary uppercase tracking-wide">Approved</div>
            </div>
            <div class="card text-center p-4">
                <div class="text-3xl font-bold text-info mb-1" id="sentCount">0</div>
                <div class="text-xs font-medium text-secondary uppercase tracking-wide">Sent</div>
            </div>
            <div class="card text-center p-4">
                <div class="text-3xl font-bold text-danger mb-1" id="rejectedCount">0</div>
                <div class="text-xs font-medium text-secondary uppercase tracking-wide">Rejected</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="card animate-fade-in delay-200 p-0 overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <h3 class="m-0 text-base font-semibold">Email Queue</h3>
                <div class="flex gap-sm">
                    <button class="btn btn-sm btn-primary active" data-status="PENDING">Pending</button>
                    <button class="btn btn-sm btn-secondary" data-status="APPROVED">Approved</button>
                    <button class="btn btn-sm btn-secondary" data-status="SENT">Sent</button>
                    <button class="btn btn-sm btn-secondary" data-status="REJECTED">Rejected</button>
                    <button class="btn btn-sm btn-secondary" data-status="FAILED">Failed</button>
                </div>
            </div>
            
            <div class="email-list" id="emailList">
                <div class="p-8 text-center text-muted">Loading...</div>
            </div>
        </div>
    </div>

    <!-- View Detail Modal -->
    <div class="modal" id="detailModal">
        <div class="modal-content animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h2 class="text-xl m-0">Email Details</h2>
                <button class="btn btn-secondary btn-sm" onclick="closeModal()">✕</button>
            </div>
            <div id="modalBody" class="flex flex-col gap-md"></div>
            <div class="mt-6 flex justify-end pt-4 border-t">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Reject Reason Modal -->
    <div class="modal" id="rejectModal">
        <div class="modal-content animate-fade-in" style="max-width: 500px;">
            <h2 class="mb-4 text-xl">Reject Email</h2>
            <div class="input-group">
                <label class="input-label">Reason for rejection (optional)</label>
                <textarea class="form-control" id="rejectionReason" rows="4" placeholder="Enter reason..."></textarea>
            </div>
            <div class="flex justify-end gap-sm mt-4">
                <button class="btn btn-secondary" onclick="closeRejectModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmReject()">Confirm Rejection</button>
            </div>
        </div>
    </div>

    <script>
        let currentStatus = 'PENDING';
        let currentRejectId = null;

        // Load counts
        async function loadCounts() {
            try {
                const response = await fetch('/api/email/pending/count');
                const counts = await response.json();
                document.getElementById('pendingCount').textContent = counts.pending || 0;
                document.getElementById('approvedCount').textContent = counts.approved || 0;
                document.getElementById('sentCount').textContent = counts.sent || 0;
                document.getElementById('rejectedCount').textContent = counts.rejected || 0;
            } catch (error) {
                console.error('Failed to load counts:', error);
            }
        }

        // Load emails by status
        async function loadEmails(status) {
            currentStatus = status;
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = '<div class="p-8 text-center text-muted">Loading...</div>';

            try {
                const response = await fetch(`/api/email/pending/status/${status}`);
                const emails = await response.json();

                if (emails.length === 0) {
                    emailList.innerHTML = `
                        <div class="p-12 text-center text-muted">
                            <div class="mb-4 flex justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12 text-gray-300" style="width: 48px; height: 48px;">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 9v.906a2.25 2.25 0 01-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 001.183 1.981l6.478 3.488m8.839 2.51l-4.66-2.51m0 0l-1.023-.55a2.25 2.25 0 00-2.134 0l-1.022.55m0 0l-4.661 2.51m16.5 1.615a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V8.844a2.25 2.25 0 011.183-1.98l7.5-4.04a2.25 2.25 0 012.134 0l7.5 4.04a2.25 2.25 0 011.183 1.98V19.5z" />
                                </svg>
                            </div>
                            <div>No emails found with this status</div>
                        </div>
                    `;
                    return;
                }

                emailList.innerHTML = emails.map(email => createEmailItem(email)).join('');
            } catch (error) {
                console.error('Failed to load emails:', error);
                emailList.innerHTML = `
                    <div class="p-12 text-center text-danger">
                        <div>Failed to load emails</div>
                    </div>
                `;
            }
        }

        // Create email item HTML
        function createEmailItem(email) {
            const statusColors = {
                'PENDING': 'warning',
                'APPROVED': 'success',
                'REJECTED': 'danger',
                'SENT': 'info',
                'FAILED': 'danger'
            };
            const badgeColor = statusColors[email.status] || 'secondary';
            
            const createdDate = new Date(email.createdAt).toLocaleString();
            const preview = email.replyContent.substring(0, 150) + (email.replyContent.length > 150 ? '...' : '');

            const actions = email.status === 'PENDING' ? `
                <button class="btn btn-primary btn-sm" onclick="approveEmail(${email.id})">✓ Approve & Send</button>
                <button class="btn btn-danger btn-sm" onclick="openRejectModal(${email.id})">✗ Reject</button>
            ` : '';

            return `
                <div class="email-item">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-lg mb-1 text-main">From: ${email.fromEmail}</div>
                            <div class="text-secondary text-sm">Subject: ${email.originalSubject}</div>
                        </div>
                        <div class="text-right">
                            <span class="badge badge-${badgeColor} mb-1">${email.status}</span>
                            <div class="text-xs text-muted">${createdDate}</div>
                        </div>
                    </div>
                    
                    <div class="email-preview" id="preview-${email.id}">${preview}</div>
                    
                    <div class="flex gap-sm mt-4">
                        ${actions}
                        <button class="btn btn-secondary btn-sm" onclick="viewDetail(${email.id})">View Details</button>
                        <button class="btn btn-secondary btn-sm" onclick="togglePreview(${email.id})">Expand Preview</button>
                    </div>
                </div>
            `;
        }

        // Toggle preview expansion
        function togglePreview(id) {
            const preview = document.getElementById(`preview-${id}`);
            preview.classList.toggle('expanded');
            event.target.textContent = preview.classList.contains('expanded') ? 'Collapse' : 'Expand Preview';
        }

        // View email detail
        async function viewDetail(id) {
            try {
                const response = await fetch(`/api/email/pending/${id}`);
                const email = await response.json();

                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="input-group">
                        <label class="input-label">From</label>
                        <div class="form-control bg-gray-50 text-secondary">${email.fromEmail}</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">To</label>
                        <div class="form-control bg-gray-50 text-secondary">${email.toEmail}</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Subject</label>
                        <div class="form-control bg-gray-50 text-secondary">${email.originalSubject}</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Original Content</label>
                        <div class="form-control bg-gray-50 text-secondary" style="white-space: pre-wrap;">${email.originalContent}</div>
                    </div>
                    <div class="input-group">
                        <label class="input-label">Generated Reply</label>
                        <div class="form-control bg-gray-50 text-secondary" style="white-space: pre-wrap;">${email.replyContent}</div>
                    </div>
                    ${email.rejectionReason ? `
                        <div class="input-group">
                            <label class="input-label text-danger">Rejection Reason</label>
                            <div class="form-control bg-red-50 text-danger">${email.rejectionReason}</div>
                        </div>
                    ` : ''}
                `;

                document.getElementById('detailModal').classList.add('active');
            } catch (error) {
                console.error('Failed to load email detail:', error);
                alert('Failed to load email details.');
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        async function approveEmail(id) {
            if (!confirm('Are you sure you want to approve and send this email?')) return;

            try {
                const response = await fetch(`/api/email/pending/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reviewedBy: 'admin' })
                });

                const result = await response.json();
                if (result.success) {
                    loadEmails(currentStatus);
                    loadCounts();
                } else {
                    alert('Failed: ' + result.message);
                }
            } catch (error) {
                console.error('Failed to approve email:', error);
                alert('Error approving email.');
            }
        }

        function openRejectModal(id) {
            currentRejectId = id;
            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectModal').classList.add('active');
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').classList.remove('active');
            currentRejectId = null;
        }

        async function confirmReject() {
            if (!currentRejectId) return;
            const reason = document.getElementById('rejectionReason').value.trim();

            try {
                const response = await fetch(`/api/email/pending/${currentRejectId}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        reviewedBy: 'admin',
                        rejectionReason: reason || null
                    })
                });

                const result = await response.json();
                if (result.success) {
                    closeRejectModal();
                    loadEmails(currentStatus);
                    loadCounts();
                } else {
                    alert('Failed: ' + result.message);
                }
            } catch (error) {
                console.error('Failed to reject email:', error);
                alert('Error rejecting email.');
            }
        }

        // Filter button handlers
        document.querySelectorAll('.btn[data-status]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.btn[data-status]').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-secondary');
                });
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                loadEmails(btn.dataset.status);
            });
        });
        
        // Set initial active button style
        document.querySelector('.btn[data-status="PENDING"]').classList.remove('btn-secondary');
        document.querySelector('.btn[data-status="PENDING"]').classList.add('btn-primary');

        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        });

        // Initial load
        loadCounts();
        loadEmails('PENDING');

        // Auto refresh
        setInterval(() => {
            loadCounts();
            loadEmails(currentStatus);
        }, 30000);
    </script>
</body>
</html>
