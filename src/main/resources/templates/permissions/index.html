<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permission Management</title>
    <link rel="stylesheet" th:href="@{/css/permissions.css}">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>üîê Permission Management</h1>
                <p class="subtitle">Manage document access permissions for users</p>
            </div>
            <button class="btn-analytics" onclick="location.href='/admin/chat/analytics'">üìä Analytics</button>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" th:text="${totalUsers}">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" th:text="${totalPaths}">0</div>
                <div class="stat-label">Document Paths</div>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Quick Actions</h2>
            <div class="quick-links">
                <a href="/chat" class="quick-link" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="quick-link-title">ü§ñ Chat Interface</div>
                    <div class="quick-link-desc">AI-powered document search and Q&A</div>
                </a>
                    <a href="/admin/permissions/manage" class="quick-link">
                        <h3 class="quick-link-title">‚öôÔ∏è Manage Permissions</h3>
                        <p class="quick-link-desc">Define and adjust access levels for paths and users.</p>
                    </a>
                    <a href="/admin/permissions/paths" class="quick-link">
                        <h3 class="quick-link-title">üìÑ View All Paths</h3>
                        <p class="quick-link-desc">Browse all protected paths and their configurations.</p>
                    </a>
                    <a href="/admin/permissions/users" class="quick-link">
                        <h3 class="quick-link-title">üë• View All Users</h3>
                        <p class="quick-link-desc">See all users and their assigned permissions.</p>
                    </a>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Recent Users</h2>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f9fafb; text-align: left;">
                        <th style="padding: 12px; font-weight: 600; color: #374151;">Email</th>
                        <th style="padding: 12px; font-weight: 600; color: #374151;">Name</th>
                        <th style="padding: 12px; font-weight: 600; color: #374151;">Status</th>
                        <th style="padding: 12px; font-weight: 600; color: #374151;">Actions</th>
                    </tr>
                </thead>
                <tbody id="recentUsersTableBody">
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px;">Loading recent users...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function loadRecentUsers() {
            const tableBody = document.getElementById('recentUsersTableBody');
            tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Loading recent users...</td></tr>';

            try {
                const response = await fetch('/api/admin/users/recent');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const users = await response.json();

                if (users.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #6b7280;">No recent users found.</td></tr>';
                    return;
                }

                tableBody.innerHTML = users.map(user => `
                    <tr style="border-bottom: 1px solid #e5e7eb;">
                        <td class="px-4 py-3">${user.email}</td>
                        <td class="px-4 py-3">${user.name}</td>
                        <td class="px-4 py-3">
                            <span class="status-badge ${user.active ? 'status-active' : 'status-inactive'}">${user.active ? 'Active' : 'Inactive'}</span>
                        </td>
                        <td class="px-4 py-3">
                            <a href="/admin/permissions/user/${user.email}" class="btn btn-view-details">View Details</a>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                console.error('Failed to load recent users:', error);
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #ef4444;">Failed to load recent users.</td></tr>';
            }
        }

        // Initial load
        document.addEventListener('DOMContentLoaded', loadRecentUsers);
    </script>
</body>
</html>