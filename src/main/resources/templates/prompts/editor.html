<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${mode == 'create' ? 'Create Prompt' : 'Edit Prompt'}">Prompt Editor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px; 
        }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { 
            background: white; 
            padding: 25px 30px; 
            border-radius: 12px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-left h1 { 
            color: #333; 
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .subtitle { color: #666; font-size: 14px; }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
        }
        
        .editor-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 24px;
        }
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #667eea;
        }
        .form-input:disabled {
            background: #f3f4f6;
            cursor: not-allowed;
        }
        .form-textarea {
            min-height: 400px;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
        }
        
        .char-count {
            text-align: right;
            font-size: 12px;
            color: #9ca3af;
            margin-top: 4px;
        }
        
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px; 
            font-weight: 600; 
            cursor: pointer; 
            text-decoration: none; 
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s; 
        }
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary { 
            background: #f3f4f6; 
            color: #374151; 
        }
        .btn-secondary:hover { background: #e5e7eb; }
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        
        /* AI Assistant Panel */
        .assistant-panel {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .assistant-title {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .assistant-desc {
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .suggestion-input {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
            margin-bottom: 12px;
        }
        .suggestion-input:focus {
            border-color: #667eea;
        }
        
        .template-section {
            margin-top: 24px;
        }
        .template-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }
        .template-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .template-item {
            padding: 12px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }
        .template-item:hover {
            background: #f3f4f6;
            border-color: #667eea;
        }
        .template-name {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }
        .template-desc {
            color: #6b7280;
            font-size: 12px;
        }
        
        .tips-section {
            margin-top: 24px;
            padding: 16px;
            background: #eff6ff;
            border-left: 4px solid #667eea;
            border-radius: 6px;
        }
        .tips-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 8px;
        }
        .tips-list {
            list-style: none;
            padding: 0;
        }
        .tips-list li {
            color: #1e40af;
            font-size: 12px;
            margin-bottom: 6px;
            padding-left: 16px;
            position: relative;
        }
        .tips-list li::before {
            content: 'ğŸ’¡';
            position: absolute;
            left: 0;
        }
        
        .ai-suggestion-box {
            margin-top: 16px;
            padding: 16px;
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            display: none;
        }
        .ai-suggestion-box.show {
            display: block;
        }
        .ai-suggestion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .ai-suggestion-title {
            font-size: 13px;
            font-weight: 600;
            color: #166534;
        }
        .ai-suggestion-content {
            color: #166534;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 24px;
        }
        .stat-box {
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            text-align: center;
        }
        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }
        .stat-label {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .error-message {
            padding: 12px 16px;
            background: #fee2e2;
            border: 1px solid #fecaca;
            border-radius: 8px;
            color: #991b1b;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }
        .error-message.show {
            display: block;
        }
        
        .success-message {
            padding: 12px 16px;
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            border-radius: 8px;
            color: #065f46;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }
        .success-message.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1>
                    <span th:text="${mode == 'create' ? 'â•' : 'âœï¸'}">âœï¸</span>
                    <span th:text="${mode == 'create' ? 'ìƒˆ í”„ë¡¬í”„íŠ¸ ë§Œë“¤ê¸°' : 'í”„ë¡¬í”„íŠ¸ ìˆ˜ì •'}">Prompt Editor</span>
                </h1>
                <p class="subtitle" th:text="${mode == 'create' ? 'AI ì–´ì‹œìŠ¤í„´íŠ¸ì˜ ë„ì›€ì„ ë°›ì•„ íš¨ê³¼ì ì¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”' : 'í”„ë¡¬í”„íŠ¸ë¥¼ ìˆ˜ì •í•˜ë©´ ìƒˆ ë²„ì „ì´ ìƒì„±ë©ë‹ˆë‹¤'}">Create or edit prompts</p>
            </div>
            <a href="/admin/prompts" class="btn btn-secondary">
                <span>â† ëª©ë¡ìœ¼ë¡œ</span>
            </a>
        </div>

        <div class="main-content">
            <!-- Editor Section -->
            <div class="editor-section">
                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>
                
                <form id="promptForm">
                    <div class="form-group">
                        <label class="form-label" for="promptType">í”„ë¡¬í”„íŠ¸ íƒ€ì… *</label>
                        <input 
                            type="text" 
                            id="promptType" 
                            class="form-input" 
                            placeholder="ì˜ˆ: general, document-search, meeting-records"
                            th:value="${prompt?.type}"
                            th:disabled="${mode == 'edit'}"
                            required>
                        <div style="font-size: 12px; color: #6b7280; margin-top: 4px;">
                            í”„ë¡¬í”„íŠ¸ì˜ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤. ì†Œë¬¸ìì™€ í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="promptContent">í”„ë¡¬í”„íŠ¸ ë‚´ìš© *</label>
                        <textarea 
                            id="promptContent" 
                            class="form-input form-textarea" 
                            placeholder="í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...&#10;&#10;íŒ: ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì§€ì‹œì‚¬í•­ì„ ì‘ì„±í•˜ì„¸ìš”.&#10;ë³€ìˆ˜ëŠ” {{variable}} í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                            required
                        >[[${prompt?.content}]]</textarea>
                        <div class="char-count">
                            <span id="charCount">0</span> characters
                        </div>
                    </div>
                    
                    <div class="button-group">
                        <button type="submit" class="btn btn-primary" id="saveBtn">
                            <span>ğŸ’¾</span>
                            <span th:text="${mode == 'create' ? 'í”„ë¡¬í”„íŠ¸ ìƒì„±' : 'ë³€ê²½ì‚¬í•­ ì €ì¥'}">Save</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="previewBtn">
                            <span>ğŸ‘ï¸</span>
                            <span>ë¯¸ë¦¬ë³´ê¸°</span>
                        </button>
                        <a href="/admin/prompts" class="btn btn-secondary">
                            <span>ì·¨ì†Œ</span>
                        </a>
                    </div>
                </form>
            </div>

            <!-- AI Assistant Panel -->
            <div class="assistant-panel">
                <div class="assistant-title">
                    <span>ğŸ¤–</span>
                    <span>AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
                </div>
                <p class="assistant-desc">
                    AIì˜ ë„ì›€ì„ ë°›ì•„ íš¨ê³¼ì ì¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”. ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„¤ëª…í•˜ë©´ ì ì ˆí•œ í”„ë¡¬í”„íŠ¸ë¥¼ ì œì•ˆí•´ë“œë¦½ë‹ˆë‹¤.
                </p>
                
                <textarea 
                    id="aiSuggestionInput" 
                    class="suggestion-input" 
                    style="min-height: 100px;"
                    placeholder="ì˜ˆ: ë¬¸ì„œ ê²€ìƒ‰ ì‹œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  ê´€ë ¨ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“¤ì–´ì¤˜"></textarea>
                
                <button type="button" class="btn btn-primary" id="generateBtn" style="width: 100%;">
                    <span>âœ¨</span>
                    <span>AIë¡œ í”„ë¡¬í”„íŠ¸ ìƒì„±</span>
                </button>
                
                <div id="aiSuggestionBox" class="ai-suggestion-box">
                    <div class="ai-suggestion-header">
                        <span class="ai-suggestion-title">AI ì œì•ˆ</span>
                        <button type="button" class="btn btn-secondary" id="applySuggestionBtn" style="padding: 6px 12px; font-size: 12px;">
                            <span>ì ìš©</span>
                        </button>
                    </div>
                    <div id="aiSuggestionContent" class="ai-suggestion-content"></div>
                </div>
                
                <div class="template-section" style="margin-top: 24px;">
                    <div class="template-title">ğŸ¯ AI ì¶”ì²œ ê¸°ëŠ¥</div>
                    <div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;">
                        <button type="button" class="btn btn-primary" id="analyzeBtn" style="width: 100%; font-size: 13px; padding: 10px;">
                            <span>ğŸ“Š</span>
                            <span>í’ˆì§ˆ ë¶„ì„</span>
                        </button>
                        <button type="button" class="btn btn-secondary" id="improveBtn" style="width: 100%; font-size: 13px; padding: 10px;">
                            <span>âœ¨</span>
                            <span>ê°œì„  ì œì•ˆ</span>
                        </button>
                    </div>
                    
                    <div id="qualityAnalysis" class="ai-suggestion-box" style="margin-top: 0;">
                        <div class="ai-suggestion-header">
                            <span class="ai-suggestion-title">í’ˆì§ˆ ë¶„ì„ ê²°ê³¼</span>
                            <button type="button" class="btn btn-secondary" id="closeAnalysisBtn" style="padding: 4px 8px; font-size: 11px;">
                                <span>âœ•</span>
                            </button>
                        </div>
                        <div id="analysisContent">
                            <div id="qualityScore" style="font-size: 24px; font-weight: 700; color: #667eea; margin-bottom: 12px;"></div>
                            <div id="qualitySuggestions" style="font-size: 12px; color: #166534; margin-bottom: 12px; white-space: pre-wrap;"></div>
                            <div id="strengthsList" style="margin-bottom: 12px;"></div>
                            <div id="improvementsList"></div>
                            <div id="similarPrompts" style="margin-top: 12px;"></div>
                        </div>
                    </div>
                    
                    <div id="improvementSuggestion" class="ai-suggestion-box" style="margin-top: 12px;">
                        <div class="ai-suggestion-header">
                            <span class="ai-suggestion-title">ê°œì„  ì œì•ˆ</span>
                            <div style="display: flex; gap: 4px;">
                                <button type="button" class="btn btn-primary" id="applyImprovementBtn" style="padding: 4px 8px; font-size: 11px;">
                                    <span>ì ìš©</span>
                                </button>
                                <button type="button" class="btn btn-secondary" id="closeImprovementBtn" style="padding: 4px 8px; font-size: 11px;">
                                    <span>âœ•</span>
                                </button>
                            </div>
                        </div>
                        <div id="improvementContent" style="font-family: 'Monaco', 'Menlo', 'Courier New', monospace; font-size: 12px; line-height: 1.6; color: #166534; white-space: pre-wrap; max-height: 200px; overflow-y: auto;"></div>
                        <div id="changesList" style="margin-top: 12px; font-size: 11px; color: #166534;"></div>
                    </div>
                </div>
                
                <div class="template-section">
                    <div class="template-title">í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿</div>
                    <div class="template-list">
                        <div class="template-item" data-template="classification">
                            <div class="template-name">ë¶„ë¥˜ í”„ë¡¬í”„íŠ¸</div>
                            <div class="template-desc">ì‚¬ìš©ì ì…ë ¥ì„ ì¹´í…Œê³ ë¦¬ë¡œ ë¶„ë¥˜</div>
                        </div>
                        <div class="template-item" data-template="extraction">
                            <div class="template-name">ì¶”ì¶œ í”„ë¡¬í”„íŠ¸</div>
                            <div class="template-desc">í…ìŠ¤íŠ¸ì—ì„œ ì •ë³´ ì¶”ì¶œ</div>
                        </div>
                        <div class="template-item" data-template="generation">
                            <div class="template-name">ìƒì„± í”„ë¡¬í”„íŠ¸</div>
                            <div class="template-desc">ìƒˆë¡œìš´ ì½˜í…ì¸  ìƒì„±</div>
                        </div>
                        <div class="template-item" data-template="analysis">
                            <div class="template-name">ë¶„ì„ í”„ë¡¬í”„íŠ¸</div>
                            <div class="template-desc">ë°ì´í„° ë¶„ì„ ë° ìš”ì•½</div>
                        </div>
                    </div>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="wordCount">0</div>
                        <div class="stat-label">ë‹¨ì–´ ìˆ˜</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="lineCount">0</div>
                        <div class="stat-label">ì¤„ ìˆ˜</div>
                    </div>
                </div>
                
                <div class="tips-section">
                    <div class="tips-title">íš¨ê³¼ì ì¸ í”„ë¡¬í”„íŠ¸ ì‘ì„± íŒ</div>
                    <ul class="tips-list">
                        <li>ëª…í™•í•˜ê³  êµ¬ì²´ì ì¸ ì§€ì‹œì‚¬í•­ì„ í¬í•¨í•˜ì„¸ìš”</li>
                        <li>ì›í•˜ëŠ” ì¶œë ¥ í˜•ì‹ì„ ëª…ì‹œí•˜ì„¸ìš”</li>
                        <li>ì˜ˆì‹œë¥¼ í¬í•¨í•˜ë©´ ë” ì¢‹ì€ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        <li>ë³€ìˆ˜ëŠ” {{variable}} í˜•ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ì„¸ìš”</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        const promptContent = document.getElementById('promptContent');
        const promptType = document.getElementById('promptType');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const lineCount = document.getElementById('lineCount');
        const promptForm = document.getElementById('promptForm');
        const saveBtn = document.getElementById('saveBtn');
        const generateBtn = document.getElementById('generateBtn');
        const aiSuggestionInput = document.getElementById('aiSuggestionInput');
        const aiSuggestionBox = document.getElementById('aiSuggestionBox');
        const aiSuggestionContent = document.getElementById('aiSuggestionContent');
        const applySuggestionBtn = document.getElementById('applySuggestionBtn');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const mode = '[[${mode}]]';
        
        // Template definitions
        const templates = {
            classification: `ë‹¹ì‹ ì€ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë¶„ë¥˜í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ ì¤‘ í•˜ë‚˜ë¡œ ì§ˆë¬¸ì„ ë¶„ë¥˜í•˜ì„¸ìš”:
- DOCUMENT_SEARCH: ë¬¸ì„œ ê²€ìƒ‰ ìš”ì²­
- MEETING_RECORDS: íšŒì˜ë¡ ì¡°íšŒ
- GENERAL_QUESTION: ì¼ë°˜ì ì¸ ì§ˆë¬¸
- OTHER: ê¸°íƒ€

ì‚¬ìš©ì ì§ˆë¬¸: {{query}}

ë¶„ë¥˜ ê²°ê³¼ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”:
{
  "category": "DOCUMENT_SEARCH",
  "confidence": 0.95,
  "reason": "ë¶„ë¥˜ ì´ìœ "
}`,
            extraction: `ë‹¹ì‹ ì€ í…ìŠ¤íŠ¸ì—ì„œ í•µì‹¬ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

ë‹¤ìŒ í…ìŠ¤íŠ¸ì—ì„œ ì¤‘ìš”í•œ ì •ë³´ë¥¼ ì¶”ì¶œí•˜ì„¸ìš”:
{{text}}

ë‹¤ìŒ í•­ëª©ì„ ì¶”ì¶œí•˜ì„¸ìš”:
- ì£¼ìš” ì—”í‹°í‹° (ì‚¬ëŒ, ì¥ì†Œ, ì¡°ì§)
- ë‚ ì§œ ë° ì‹œê°„
- í•µì‹¬ í‚¤ì›Œë“œ
- ìš”ì•½

ê²°ê³¼ë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”.`,
            generation: `ë‹¹ì‹ ì€ ì°½ì˜ì ì¸ ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

ì£¼ì œ: {{topic}}
í†¤: {{tone}}
ê¸¸ì´: {{length}}

ìœ„ ì¡°ê±´ì— ë§ëŠ” ì½˜í…ì¸ ë¥¼ ìƒì„±í•˜ì„¸ìš”.
ëª…í™•í•˜ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ë¬¸ì¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.`,
            analysis: `ë‹¹ì‹ ì€ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ëŠ” AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.

ë‹¤ìŒ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì„¸ìš”:
{{data}}

ë¶„ì„ ê²°ê³¼ì— í¬í•¨í•  ë‚´ìš©:
1. ì£¼ìš” íŒ¨í„´ ë° íŠ¸ë Œë“œ
2. ì´ìƒì¹˜ ë˜ëŠ” íŠ¹ì´ì‚¬í•­
3. ì‹¤í–‰ ê°€ëŠ¥í•œ ì¸ì‚¬ì´íŠ¸
4. ìš”ì•½ ë° ê²°ë¡ 

ë¶„ì„ ê²°ê³¼ë¥¼ êµ¬ì¡°í™”ëœ í˜•ì‹ìœ¼ë¡œ ì œê³µí•˜ì„¸ìš”.`
        };
        
        // Update stats
        function updateStats() {
            const content = promptContent.value;
            const chars = content.length;
            const words = content.trim() ? content.trim().split(/\s+/).length : 0;
            const lines = content.split('\n').length;
            
            charCount.textContent = chars.toLocaleString();
            wordCount.textContent = words.toLocaleString();
            lineCount.textContent = lines.toLocaleString();
        }
        
        // Initialize stats
        updateStats();
        
        // Update stats on input
        promptContent.addEventListener('input', updateStats);
        
        // Template selection
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', () => {
                const template = item.dataset.template;
                if (templates[template]) {
                    promptContent.value = templates[template];
                    updateStats();
                    promptContent.focus();
                }
            });
        });
        
        // AI suggestion generation
        generateBtn.addEventListener('click', async () => {
            const suggestion = aiSuggestionInput.value.trim();
            if (!suggestion) {
                showError('AI ì–´ì‹œìŠ¤í„´íŠ¸ì—ê²Œ ì›í•˜ëŠ” ê¸°ëŠ¥ì„ ì„¤ëª…í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner"></span><span>ìƒì„± ì¤‘...</span>';
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: `ë‹¤ìŒ ìš”êµ¬ì‚¬í•­ì— ë§ëŠ” íš¨ê³¼ì ì¸ AI í”„ë¡¬í”„íŠ¸ë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”. í”„ë¡¬í”„íŠ¸ë§Œ ì‘ì„±í•˜ê³  ë‹¤ë¥¸ ì„¤ëª…ì€ í•„ìš”ì—†ìŠµë‹ˆë‹¤:\n\n${suggestion}`,
                        sessionId: 'prompt-gen-' + Date.now()
                    })
                });
                
                if (!response.ok) {
                    throw new Error('AI ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                }
                
                // Read streaming response
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let accumulatedText = '';
                let buffer = '';
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data:')) {
                            let data = line.slice(5).trim();
                            if (data && data !== '[DONE]') {
                                accumulatedText += data;
                            }
                        }
                    }
                }
                
                if (accumulatedText) {
                    aiSuggestionContent.textContent = accumulatedText.trim();
                    aiSuggestionBox.classList.add('show');
                } else {
                    throw new Error('AI ì‘ë‹µì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('Error:', error);
                showError('AI ì œì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>âœ¨</span><span>AIë¡œ í”„ë¡¬í”„íŠ¸ ìƒì„±</span>';
            }
        });
        
        // Apply AI suggestion
        applySuggestionBtn.addEventListener('click', () => {
            const suggestion = aiSuggestionContent.textContent;
            if (suggestion) {
                promptContent.value = suggestion;
                updateStats();
                promptContent.focus();
                showSuccess('AI ì œì•ˆì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        });
        
        // Quality Analysis
        const analyzeBtn = document.getElementById('analyzeBtn');
        const qualityAnalysis = document.getElementById('qualityAnalysis');
        const closeAnalysisBtn = document.getElementById('closeAnalysisBtn');
        const qualityScore = document.getElementById('qualityScore');
        const qualitySuggestions = document.getElementById('qualitySuggestions');
        const strengthsList = document.getElementById('strengthsList');
        const improvementsList = document.getElementById('improvementsList');
        const similarPrompts = document.getElementById('similarPrompts');
        
        analyzeBtn.addEventListener('click', async () => {
            const content = promptContent.value.trim();
            if (!content) {
                showError('ë¶„ì„í•  í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<span class="loading-spinner"></span><span>ë¶„ì„ ì¤‘...</span>';
            
            try {
                const type = promptType.value.trim() || null;
                const response = await fetch('/api/prompts/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content,
                        type: type
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const result = await response.json();
                
                // Display score
                qualityScore.textContent = `í’ˆì§ˆ ì ìˆ˜: ${result.score}/100`;
                qualityScore.style.color = result.score >= 80 ? '#10b981' : result.score >= 60 ? '#f59e0b' : '#ef4444';
                
                // Display suggestions
                qualitySuggestions.textContent = result.suggestions;
                
                // Display strengths
                if (result.strengths && result.strengths.length > 0) {
                    strengthsList.innerHTML = `
                        <div style="font-size: 12px; font-weight: 600; color: #10b981; margin-bottom: 6px;">âœ… ê°•ì :</div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #166534;">
                            ${result.strengths.map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    strengthsList.innerHTML = '';
                }
                
                // Display improvements
                if (result.improvements && result.improvements.length > 0) {
                    improvementsList.innerHTML = `
                        <div style="font-size: 12px; font-weight: 600; color: #f59e0b; margin-bottom: 6px;">ğŸ’¡ ê°œì„  ì‚¬í•­:</div>
                        <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #166534;">
                            ${result.improvements.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    improvementsList.innerHTML = '';
                }
                
                // Display similar prompts
                if (result.similarPrompts && result.similarPrompts.length > 0) {
                    similarPrompts.innerHTML = `
                        <div style="font-size: 12px; font-weight: 600; color: #667eea; margin-bottom: 6px;">ğŸ” ìœ ì‚¬í•œ í”„ë¡¬í”„íŠ¸:</div>
                        <div style="font-size: 11px;">
                            ${result.similarPrompts.map(p => `
                                <div style="background: white; padding: 8px; border-radius: 4px; margin-bottom: 6px; border: 1px solid #e5e7eb;">
                                    <div style="font-weight: 600; color: #374151;">v${p.version} (ìœ ì‚¬ë„: ${(p.similarity * 100).toFixed(0)}%)</div>
                                    <div style="color: #6b7280; margin-top: 4px;">${p.preview}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    similarPrompts.innerHTML = '';
                }
                
                qualityAnalysis.classList.add('show');
                
            } catch (error) {
                console.error('Error:', error);
                showError('í’ˆì§ˆ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<span>ğŸ“Š</span><span>í’ˆì§ˆ ë¶„ì„</span>';
            }
        });
        
        closeAnalysisBtn.addEventListener('click', () => {
            qualityAnalysis.classList.remove('show');
        });
        
        // Improvement Suggestion
        const improveBtn = document.getElementById('improveBtn');
        const improvementSuggestion = document.getElementById('improvementSuggestion');
        const improvementContent = document.getElementById('improvementContent');
        const changesList = document.getElementById('changesList');
        const applyImprovementBtn = document.getElementById('applyImprovementBtn');
        const closeImprovementBtn = document.getElementById('closeImprovementBtn');
        let currentImprovedPrompt = '';
        
        improveBtn.addEventListener('click', async () => {
            const content = promptContent.value.trim();
            if (!content) {
                showError('ê°œì„ í•  í”„ë¡¬í”„íŠ¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            improveBtn.disabled = true;
            improveBtn.innerHTML = '<span class="loading-spinner"></span><span>ê°œì„  ì¤‘...</span>';
            
            try {
                const response = await fetch('/api/prompts/improve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        content: content
                    })
                });
                
                if (!response.ok) {
                    throw new Error('ê°œì„  ì œì•ˆ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                const result = await response.json();
                
                currentImprovedPrompt = result.improved;
                improvementContent.textContent = result.improved;
                
                if (result.changes && result.changes.length > 0) {
                    changesList.innerHTML = `
                        <div style="font-weight: 600; margin-bottom: 6px;">ë³€ê²½ ì‚¬í•­:</div>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${result.changes.map(c => `<li>${c}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    changesList.innerHTML = '';
                }
                
                improvementSuggestion.classList.add('show');
                
            } catch (error) {
                console.error('Error:', error);
                showError('ê°œì„  ì œì•ˆ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            } finally {
                improveBtn.disabled = false;
                improveBtn.innerHTML = '<span>âœ¨</span><span>ê°œì„  ì œì•ˆ</span>';
            }
        });
        
        applyImprovementBtn.addEventListener('click', () => {
            if (currentImprovedPrompt) {
                promptContent.value = currentImprovedPrompt;
                updateStats();
                promptContent.focus();
                showSuccess('ê°œì„ ëœ í”„ë¡¬í”„íŠ¸ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!');
                improvementSuggestion.classList.remove('show');
            }
        });
        
        closeImprovementBtn.addEventListener('click', () => {
            improvementSuggestion.classList.remove('show');
        });
        
        // Form submission
        promptForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const type = promptType.value.trim();
            const content = promptContent.value.trim();
            
            if (!type || !content) {
                showError('í”„ë¡¬í”„íŠ¸ íƒ€ì…ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // Validate type format
            if (!/^[a-z0-9-]+$/.test(type)) {
                showError('í”„ë¡¬í”„íŠ¸ íƒ€ì…ì€ ì†Œë¬¸ì, ìˆ«ì, í•˜ì´í”ˆ(-)ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<span class="loading-spinner"></span><span>ì €ì¥ ì¤‘...</span>';
            
            try {
                const url = mode === 'create' ? '/api/prompts' : `/api/prompts/${type}`;
                const method = mode === 'create' ? 'POST' : 'PUT';
                const body = mode === 'create' 
                    ? { type, content }
                    : { content };
                
                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'í”„ë¡¬í”„íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
                showSuccess('í”„ë¡¬í”„íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = '/admin/prompts';
                }, 1500);
                
            } catch (error) {
                console.error('Error:', error);
                showError('í”„ë¡¬í”„íŠ¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<span>ğŸ’¾</span><span>' + (mode === 'create' ? 'í”„ë¡¬í”„íŠ¸ ìƒì„±' : 'ë³€ê²½ì‚¬í•­ ì €ì¥') + '</span>';
            }
        });
        
        // Preview button
        document.getElementById('previewBtn').addEventListener('click', () => {
            const content = promptContent.value;
            if (!content.trim()) {
                showError('ë¯¸ë¦¬ë³¼ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // Open preview in new window
            const previewWindow = window.open('', '_blank', 'width=800,height=600');
            previewWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Prompt Preview</title>
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                            padding: 40px;
                            max-width: 800px;
                            margin: 0 auto;
                            line-height: 1.6;
                        }
                        pre {
                            background: #f3f4f6;
                            padding: 20px;
                            border-radius: 8px;
                            white-space: pre-wrap;
                            word-wrap: break-word;
                        }
                        h1 {
                            color: #333;
                            border-bottom: 2px solid #667eea;
                            padding-bottom: 10px;
                        }
                    </style>
                </head>
                <body>
                    <h1>í”„ë¡¬í”„íŠ¸ ë¯¸ë¦¬ë³´ê¸°</h1>
                    <pre>${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                </body>
                </html>
            `);
        });
        
        // Utility functions
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            successMessage.classList.remove('show');
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 5000);
        }
        
        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.classList.add('show');
            errorMessage.classList.remove('show');
            setTimeout(() => {
                successMessage.classList.remove('show');
            }, 5000);
        }
        
        // Auto-save to localStorage
        let autoSaveTimeout;
        promptContent.addEventListener('input', () => {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                localStorage.setItem('prompt-draft', JSON.stringify({
                    type: promptType.value,
                    content: promptContent.value,
                    timestamp: new Date().toISOString()
                }));
            }, 1000);
        });
        
        // Restore draft on load (only for create mode)
        if (mode === 'create') {
            const draft = localStorage.getItem('prompt-draft');
            if (draft) {
                try {
                    const data = JSON.parse(draft);
                    const draftAge = Date.now() - new Date(data.timestamp).getTime();
                    // Restore if draft is less than 1 hour old
                    if (draftAge < 3600000) {
                        if (confirm('ì €ì¥ë˜ì§€ ì•Šì€ ì´ˆì•ˆì´ ìˆìŠµë‹ˆë‹¤. ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                            promptType.value = data.type || '';
                            promptContent.value = data.content || '';
                            updateStats();
                        }
                    }
                } catch (e) {
                    console.error('Failed to restore draft:', e);
                }
            }
        }
        
        // Clear draft on successful save
        window.addEventListener('beforeunload', (e) => {
            if (promptContent.value.trim() && !saveBtn.disabled) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
